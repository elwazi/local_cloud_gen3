- name: Configure control plane
  when: "'k8s_control_plane' in group_names"
  become: yes
  tags: k8s_control_plane
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  block:
    - name: Ensure {{ ansible_user }} is in the docker group
      become: yes
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Check if kubeadm has been initialized
      command: kubectl get cs
      register: kubeadm_init_check
      ignore_errors: yes

    - name: Initialise control plane
      command: kubeadm init --pod-network-cidr=10.244.0.0/16
      when: kubeadm_init_check is failed
      register: kubeadm_init

    - name: Ensure ~{{ ansible_user }}/.kube directory exists
      file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0700

    - name: Copy /etc/kubernetes/admin.conf to {{ ansible_user }}
      copy:
        src: /etc/kubernetes/admin.conf
        remote_src: true
        dest: /home/{{ ansible_user }}/.kube/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0600

    - name: Install k9s
      tags: k9s
      become: no
      block:
        - name: Make sure ~/bin and ~/src exists
          file:
            path: "~/{{ item }}"
            state: directory
          with_items:
            - bin
            - src
        - name: Download k9s
          get_url:
            url: https://github.com/derailed/k9s/releases/download/v0.27.3/k9s_Linux_amd64.tar.gz
            dest: ~/src/k9s.tar.gz

        - name: Extract k9s
          unarchive:
            src: ~/src/k9s.tar.gz
            dest: ~/bin
            remote_src: true
            creates: ~/bin/k9s

#    - name: Deploy pod network
#      tags: pod_network, flannel
#      block:
#        - name: Copy flannel config
#          copy:
#            src: kube-flannel.yml
#            dest: /tmp/kube-flannel.yml
#        - name: Deploy flannel
#          command: kubectl apply -f /tmp/kube-flannel.yml
